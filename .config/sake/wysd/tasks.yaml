tasks:
  ping:
    desc: ping servers
    target:
      servers: [bouncer, media, hass]
    cmd: echo pong
    spec: detailed-text

  info:
    desc: Get linux machines info
    target: linux-machines
    spec: free-for-all-table
    tasks:
      - task: info-os
      - task: info-kernel
      - task: info-uptime 
  info-os:
    desc: print OS name
    cmd: |
      os=$(lsb_release -si)
      release=$(lsb_release -sr)
      echo "$os $release"

  info-kernel:
    desc: print kernel version
    cmd: uname -r | awk -v FS='-' '{print $1}'

  info-uptime:
    desc: print pretty uptime
    cmd: uptime -p


# Docker
# ------
  docker-status:
    desc: Print a short status for all Docker containers
    target: docker-hosts
    spec: free-for-all-table
    tasks:
      - task: doc-name
      - task: doc-state
      - task: doc-uptime
      - task: doc-since
      - task: doc-ports

  doc-name:
    desc: List containers by name
    cmd: docker ps -a --format '{{.Names}}'

  doc-state:
    desc: List containers states
    cmd: docker ps -a --format '{{.State}}'

  doc-uptime:
    desc: List containers uptimes
    cmd: docker ps -a --format '{{.Status}}'

  doc-since:
    desc: List containers up-since
    cmd: docker ps -a --format '{{.RunningFor}}'

  doc-ports:
    desc: List containers ports
    cmd: docker ps -a --format '{{range $i, $element := (split .Ports ",")}}{{if (or (eq $i 1) (eq $i 3) (eq $i 5) (eq $i 7) (eq $i 9) (eq $i 11) (eq $i 13))}}{{range $j, $b := (split $element "->")}}{{if (eq $j 0)}}{{range $k := (split $b ":")}}{{if $k}}{{$k}}{{end}}{{end}}{{end}}{{end}}{{end}}{{end}}'


# Call Attendant
# --------------
  phone-status:
    desc: journal for CallAttendant
    target: bouncer
    spec: simple-text
    cmd: journalctl -e -n 20 -u callattendant.service
  
  phonecalls:
    desc: Print summary table of recent call data
    target: bouncer
    spec:
      describe: false
      list_hosts: false
      output: table-2
      report: [none]
    tasks:
      - task: permitted-calls
      - task: screened-calls
      - task: blocked-calls

  blocked-calls:
    desc: Print a table of recently blocked calls
    target:
      servers: [bouncer]
    cmd: sqlite3 ~/.config/callattendant/callattendant.db 'SELECT Name, Number, Reason, Date, 'Time' FROM CallLog WHERE action = "Blocked" AND name != "O" ORDER BY CallLogId DESC LIMIT 20;' | sed 's/|/\t/g' | lcolumn -s $'\t' --table --table-columns NAME,NUMBER,REASON,DATE,TIME --table-right DATE,TIME -o ' | '

  screened-calls:
    desc: Print a table of recently screened calls
    target: 
      servers: [bouncer]
    cmd: sqlite3 ~/.config/callattendant/callattendant.db 'SELECT Name, Number, Reason, Date, 'Time' FROM CallLog WHERE action = "Screened" ORDER BY CallLogId DESC LIMIT 10;' | sed 's/|/\t/g' | lcolumn -s $'\t' --table --table-columns NAME,NUMBER,REASON,DATE,TIME --table-right DATE,TIME -o ' | '
  
  permitted-calls:
    desc: Print a table of recently permitted calls
    target: 
      servers: [bouncer]
    cmd:  sqlite3 ~/.config/callattendant/callattendant.db 'SELECT Name, Number, Reason, Date, 'Time' FROM CallLog WHERE action = "Permitted" ORDER BY CallLogId DESC LIMIT 10;' | sed 's/|/\t/g' | lcolumn -s $'\t' --table --table-columns NAME,NUMBER,REASON,DATE,TIME --table-right DATE,TIME -o ' | '


# E-Mail
# ------
  dads-email:
    desc: Dad's recent email activity
    target:
      servers: [bouncer]
    spec:
      describe: false
      list_hosts: false
      output: table-2
      report: [none]
    tasks:
      - task: dads-inbox
      - task: dads-spam
  
  dads-inbox:
    desc: Dad's recent Inbox messages
    target:
      servers: [bouncer]
    spec: simple-text
    cmd: NODE_PATH=$(npm root -g) node ~/.local/lib/js/dads_mail.js INBOX 7 | lcolumn -s $'\t' --table --table-columns FROM,SUBJECT,DATE --table-right DATE -o ' | '
  
  dads-spam:
    desc: Dad's recent "Spam"
    target:
      servers: [bouncer]
    spec: simple-text
    cmd: NODE_PATH=$(npm root -g) node ~/.local/lib/js/dads_mail.js Bulk 14 | lcolumn -s $'\t' --table --table-columns FROM,SUBJECT,DATE --table-right DATE -o ' | '
